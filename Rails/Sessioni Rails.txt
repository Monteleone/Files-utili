::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::::									    SESSIONI						           :::::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


INTRODUZIONE:
__________________
Cosa è la Sessione?

La Sessione rappresenta lo stato associato ad una sequenza di pagine visualizzate
da un utente. Prendiamo come esempio la conversazione per acquistare un prodotto.
NB: Per conversazione si intende una sequenza di pagine di senso compiuto


•l’utente inserisce username e password:Il server ottiene i dati e li
verifica con i dati presenti nel database dei registrati: viene creata la sessione.

•Utente è autorizzato, sfoglia il catalogo alla
ricerca di un prodotto; il server lo riconosce
attraverso i dati di sessione

•Trova il prodotto e lo mette nel
carrello: la sua sessione viene
aggiornata con le informazioni del
prodotto

•Compila i dati di consegna

•Provvede al pagamento, fine
della conversazione di acquisto

•La sessione è ancora attiva e l’utente può
fare una altro acquisto o uscire dal sito


La Sessione ha quindi i seguenti requisiti:
• Deve essere condivisa dal Client e dal Server
• È associata ad una o più conversazioni effettuate da un singolo utente
• Ogni utente possiede la sua singola sessione


Ci sono due tecniche di base per gestire la sessione:
1. Utilizzo della struttura dei cookie
2. Gestione di uno stato sul server per ogni utente collegato
• I cookie fanno parte dello standard http, sono quindi sempre disponibili
• La gestione dello stato sul server è possibile in alcune architetture specifiche


I cookie possono essere generati sia dal client che dal server, dopo la loro
creazione vengono sempre passati ad ogni trasmissione di request e response.


SESSIONE IN RAILS:
__________________

Rails permette di gestire le informazioni a livello di sessione tramite un hash che persiste da una
richiesta all'altra e può contenere qualsiasi oggetto serializzabile.
Esempio: uso un hash session per trovare l'ID dell'utente senza dover passare per il database.
Come abbiamo visto, Rails predilige l'uso di boilerplate code (convenction over configuration) 

La gestione della sessione è uno di quei compiti che affliggono moltissimo gli sviluppatori.
Rails usa di default un CookieStore come gestore di sessioni.
Questo significa che tutte le informazioni di cui abbiamo bisogno sulla sessione di un utente , sono 
mandate al client e NIENTE viene salvato sul server.
Quando un utente manda una richiesta, i cookie di sessione sono processati e validati, in questo modo, Rails è in grado di identificare correttamente l'utente dal database. 

I cookie quindi sono la maniera per fare ricordare al server chi siamo, tra una richiesta e l'altra.
Ogni volta che inviamo una richiesta al browser, inviamo tutti i cookie che abbiamo di quel dominio.
Un cookie di sessione di Rails, inoltre , viene crittato prima di essere inviato tramite browser.
Il cookie è un hash simile a qualcosa del genere:

cookie = {
  "session_id": "Value",
  "_csrf_token": "token",
  "user_id": "1"
}


Rails separa il concetto di sessione da quello delle specifiche di come l'informazione di sessione e' memorizzato.
La sessione, come visto fino ad ora, è un concetto astratto con il quale interagiamo indipendentemente da dove 
è salvato. Le diverse metodologie di sessioni disponibili sono:


   CookieStore
   CacheStore
   ActiveRecordStore  (usa una tabella dove salva i dati di sessione. Client e server si scambiano l'ID di sessione)


Vediamo un poco piu' da vicino il CookieStore:

Come detto Rails deve usare i cookies per gestire la conversazione tra client e server. Non importa quale sistema di store session sia usato. Avremo comunque sempre bisogno di usare i cookie , per la natura stessa del protocollo HTTP (stateless 'senza stato').

Che misure prende Rails per tenere sicuri i cookie? In Rails 4 i cookie vengono crittati , invece in Rails 3 venivano solamente codificati in Base64.
 
Base64 was created to transport data; not protect it.

In Rails 4 i cookie possono essere letti solo dal server, che è in grado di decrittarli.
Inoltre, per evitare che qualcuno possa manomettere il cookie , Rails introduce una firma (SHA  produce un message digest, o "impronta del messaggio", di lunghezza fissa partendo da un messaggio di lunghezza variabile.)
La firma viene inserita alla fine del cookie.

Quando il server riceve il cookie, prende la parte di dati prima della firma e la decodifica.
Il server ricrea la firma usando la stessa chiave segrata usata per generare la firma originale.
Se le due firme concidono il cookie non è stato manomesso. Se è stato manomesso , la sessione viene cancellata.

La chiave segreta è disponibile SOLO nel server. E' una chiave di 128 caratteri generata randomicamente. Ovviamente bisogna stare molto attenti nel proteggere questa chiave.
In Rails 4.1 it’s secret_key_base in config/secrets.yml


Potremmo chiederci quale è la differenza tra il semplice cookie e la sessione.
Vediamo questo esempio:

cookie[:foo] = 'bar'

session[:foo] = 'bar'

Inizialmente potrebbero sembrare identici , ma in realta' ci sono delle considerazioni da fare.
I cookie viaggiano in chiaro mentre i cookie della session sono (come visto prima) crittati , firmati e serializzati.
Quindi usiamo i cookie per mandare informazioni pochi importanti e la session per mandare informazioni sensibili (ID dell'utente)
Inoltre i cookie della session vengono cancellati dopo il logout o la chiusura del browser


I've got this in my config/environment.rb

  config.action_controller.session = {
    :session_key => [some key],
    :secret => [some secret]
  }

If you have secret_key_base set, your cookies will be encrypted.
If you have both secret_token and secret_key base set, your cookies will be encrypted, and signed cookies


Una sessione normalmente consiste in un hash di valori e session id.
Ogni cookie mandato al client include la sessione dell'id.
In Rails , per salvare e riprendere i valori di una sessione , possiamo usare il seguente metodo:

session[:user_id] = @current_user.id
User.find(session[:user_id])

Come possiamo vedere, usiamo un Hash per salvare l'id dell'utente
Hash - (chiave , valore )

Un session id è una stringa random, o qualcosa di simile

Nel progetto ho usato come id del carrello (per esempio) l'identificatore univoco della Tabella carts del database
ho preso l'id del carrello appena creato e l'ho salvato nella sessione (nel hash della sessione)

session[:cart_id] = @cart.id






A session cookie is signed and encrypted (encryption is new in Rails 4) then sent to the browser.











